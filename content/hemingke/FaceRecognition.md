title: 关于人脸识别和检索的项目
slug: 关于人脸识别和检索的项目
date: 2013-01-03 13:00 
tags: 技术，算法，理论
category: 后台开发
author: Mingke HE

近期快播PC端和移动端在后台悄然上线了人脸识别和搜索服务，可惜前端还没有加入必要的引导和交互，注意到的用户不多。希望用户能喜欢，同时以后能扩展到内部使用，比如：员工打卡以及年会抽奖。这个项目是由Tony、周平、卫城和我共同来完成的。

人脸识别是Computer Vision里面最有商用价值和最有挑战的领域之一。价值自不用说，难度在于：尚无强大的数学工具制造出较完美的Feature来表示人脸，做到在不同光照、不同遮挡物、不同年龄、不同表情、不同装扮等等严苛条件下依然有效。即使是肉眼，人脸识别在各个物种之间甚至是人种之间也略有不同，比如：我们看所有的鸭子都是一张脸，反之也许亦然；记得在美国读书的时候，美国同学老是说我们中国人长得一样，都是黑眼睛、黑头发、塌鼻梁等等，可见西方人描述人脸的方式和东方人不太一样。


基本算法
----

人脸项目总共分为四大部分，每一部分都是大坑，需要花费大量的精力去研究和改进：人脸检测、人脸校正、人脸特征提取和人脸检索。

**人脸检测** 大致的思路都是Haar+弱分类器级联，也有将Haar换成LBP等等的。除了脑力活，还有不少体力活。中间不少是数据调优、数据整理清理、寻找正负样本等工作。OpenCV提供了标准的人脸检测程序及基础数据来完成简单的实现。但False positive和False negative非常之高，基本不能用于真正的服务中。就此我改写了这个程序，False positive和False negative都得到大幅降低，但是因为效率太差，不能用于线上服务，只能用于离线训练。最终用的是一个高手提供的检测程序，准确率不错同时效率很高，甚至可用于视频中的人脸检测（即用于每秒几十帧的实时检测）。

**人脸标定** Tony使用的是Flandmark找关键点并根据关键点的几何位置来完成标定。Flandmark也是一套SVM的算法，对每张人脸标定出七个位置：左右眼的左右极限位置，嘴的左右极限位置，鼻尖的位置以及脸的中心点位置。而我使用的算法叫做congeal，可这样来最直观得想象这个算法：把人脸当成一张张扑克牌，叠在一起拿到手里反复摩挲来旋转扑克牌，直到找到一个最整齐的位置或者组合；评价整齐这个参数用的是entropy（熵）。人脸标定其实涉及到7个参数，假设垂直于图片并指向观众的为z轴，x轴和y轴按照右手定则确定：x/y/z轴的位置，x/y/z轴的角度和尺寸大小。前三个是位置信息，中间三个是姿态信息，最后一个是尺寸信息。上述的两个算法能解决x/y/z轴的位置、z轴的角度和尺寸，但是不是解决x/y轴的角度。用直观的语言说，就是不能把侧脸或者低头的姿态确认并量化。这将会是以后工作的一个方向。

**人脸特征提取和搜索** 在这个问题上，我和Tony开始出现分歧，于是我们拆成了两个小组，每组两个人各做一套算法，互相竞争。

>我和卫城这一组，主攻LBP Histogram(LBPH)，检索用的是LSH。当然LBP看似简单，但是有许多扩展，比如：各类LBP，variance的，扩展的，gradient的，椭圆的，Uniform的；LBP的参数，radius和neighbour；LBP加入几何信息，在人脸上分区域并配置权重……结果是：精度一般，但是适合于海量图片以及近似人脸的搜索，并且对训练集的质量依赖较小。
>
> - 对于数据库中的每张人脸（不依赖于人名）都形成一个或者若干个高维向量
> - 对于每张查询人脸(query face)也是转换成用LBPH来表示，然后通过LSH在数据库中找到一个和它欧氏距离最小的一个向量，并通过统计的方法来确认最近似的一张脸。（在实践中，使用了Chi Square来更精确得估计脸和脸之间的近似程度）

>

>  Tony和周平走的是另一条思路，结果是精度更高但扩展性略差，同时很依赖于训练集合的质量：
> 
>  - 将人脸图片转换为Dense sift特征值，对一堆人脸图片的特征值进行离线训练，并用BOVW的思路找到Visual Words。
>  - 每个人有多张人脸图片，每张图片还是提取Dense sift，然后根据BOVW用VLAD来描述这张图片，每张图片用人名来label
>  - 把这些信息扔进SVM进行训练，得到一个庞大的分类模型，每个人名对应着一堆用矩阵描述的系数
>  - 新来一张人脸图片(query face)后，还是提取Dense sift->生成VLAD->到SVM模型进行计算，对应每个人名都得到一个参数，参数表明着这张query face和某个人名对应脸的近似程度

未来的工作
-----
进一步提高Feature retrieval and representation，更精确得描述人脸以及人；同时，在人脸的检索上，目前使用的LSH是比较笨拙的，资源开销很大，KLSH和product quantization等是未来的方向，在不损耗精度甚至是提高精度的条件下大大降低资源开销。